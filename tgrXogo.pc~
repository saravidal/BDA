/*
 * Autores:
 * Daniel Lopez Lopez (d.lopez.lopez@udc.es)
 * Sara Vidal Garcia (sara.vidal@udc.es) 
 * Universidade da Coruña
 *
 * BDA - Curso 2016-2017
 *
 * TGR - XOGOS
 */

#include<stdlib.h>
#include<stdio.h>
#include<string.h>
#include<time.h>
EXEC SQL INCLUDE SQLCA;

/*
 * Utilidades para menus e ler valores por teclado.  
 */

#define MAXLEN 20
void getString(char *s, int maxlen){
	fgets(s,maxlen,stdin);
	int last = strlen(s) -1;
	if ( (s[last]=='\r') || (s[last]=='\n') )
		s[last] = '\0';
}

void getPassword(char *s, int maxlen){
	system("stty -echo");
	getString(s,maxlen);
	system("stty echo");
}

int getInt(){
	char s[MAXLEN];
	getString(s,MAXLEN);
	return atoi(s);
}

float getFloat(){
	char s[MAXLEN];
	getString(s,MAXLEN);
	return atof(s);
}



/* Menu principal */

int menu()
{
  int opcion = -1;

  int MAXOPTS = 12; /* Numero de opcions do menu */

  printf("Menu da aplicacion de Xogos\n");
  printf("==================\n\n");
  printf(" 1. Listar Xogos\n");
  printf(" 2. Buscar Xogo\n");
  printf(" 3. Buscar Autor\n");
  printf(" 4. Engadir Critica\n");
  printf(" 5. Engadir Autor\n");
  printf(" 6. Engadir Xogo\n");
  printf(" 7. Eliminar Xogo\n");
  printf(" 8. Eliminar Autor\n");
  printf(" 9. Editar Datos Autor\n");
  printf("10. Votar positivamente\n");
  printf("11. Votar negativamente\n");
  printf("==================\n\n");
  printf(" 0. Sair\n");

  while ( (opcion < 0) || (opcion > MAXOPTS)){
      printf("OP> ");
      opcion=getInt();
  }
  return opcion;
}


void erroManagerConexion(char *usr){
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	switch (sqlca.sqlcode){
		case -1017: printf("Credenciais de %s invalidas. Abortando conexion.\n", usr);
				break;
		case -1012: printf("Non estabas conectado. Saindo do programa.\n");
				break;
		default: printf("Estado: Codigo %d, Mensaxe: %.*s.\n",
	sqlca.sqlcode,
	sqlca.sqlerrm.sqlerrml,
	sqlca.sqlerrm.sqlerrmc);
	}
	exit(-1);
}

int errorManagerDML(){
	int retval = sqlca.sqlcode; 
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	switch (sqlca.sqlcode){
		case -1: printf("Erro: O DNI/CIF xa existe na base de datos.\n\n");
		case -1400: printf("Erro: Os campos marcados con * son de caracter obligatorio.\n\n")
		default: printf("\nErro: Estado: Código %d, Mensaxe: %.*s.\n\n",
		sqlca.sqlcode,
		sqlca.sqlerrm.sqlerrml,
		sqlca.sqlerrm.sqlerrmc);
	}
	EXEC SQL ROLLBACK; //Dependiendo del caso quiza no queremos hacer un rollback
	return retval;
}

/* Funcionalidadess de base de datos */

void conectaBD(){
   	EXEC SQL WHENEVER SQLERROR DO erroManagerConexion(usuario);
   	EXEC SQL BEGIN DECLARE SECTION;
      		char usuario[30];
      		char clave[30];
   	EXEC SQL END DECLARE SECTION;

   	printf("Introduce as tuas credenciais de Oracle:\n");  
   	printf("Usuario: "); getString(usuario,30);
   	printf("Clave: "); getPassword(clave,30);
   	printf("\n\nConectando con Oracle...\n");
   
   	EXEC SQL CONNECT :usuario IDENTIFIED BY :clave;

	printf("\n\nConectado!\n\n");
}


void desconectaBD(){
   EXEC SQL WHENEVER SQLERROR DO erroManagerConexion("");
   EXEC SQL COMMIT RELEASE;
}









<<<<<<< HEAD
void engadirAutor(){
=======
void engadir_autor(int doCommit){
>>>>>>> dd67eaf4e44b17aedd0f7fba9142e8d67b558dcf
	int erro = 0;		
	EXEC SQL WHENEVER SQLERROR DO erro=errorManagerDML();
   	
	EXEC SQL BEGIN DECLARE SECTION;
		int tipoxeral;
      		char id[25];
		char nome[50];
		char enlace[256];
		char tipo[30];
		int pausa;
   	EXEC SQL END DECLARE SECTION;
	EXEC SQL SET TRANSACTION ISOLATION LEVEL READ COMMITED;	

	printf("REXISTRO DE AUTORES\n\n");
	printf("Que clase de rexistro desexa facer:\n");
   	printf("(1)\tPersoa individual\n");
	printf("(2)\tGrupo\n");
	printf("Seleccione a opcion que mais se axuste a vostede.");
	printf("\n\t> ");
	tipoxeral = getInt();

	if (tipoxeral == 1){
		printf("DATOS PERSOAIS:\n");
		strcpy(tipo, "PARTICULAR");
		printf("(*) DNI\n\t> ");
		getString(id,25);
	}else{
		printf("DATOS DO GRUPO:\n");
		printf("(*) CIF ou identificador\n\t> ");
		getString(id,25);
		printf("(*) Tipo (empresa, revista...)\n\t> ");
		getString(tipo,30);
	}
	printf("(*) Nome\n\t> ");
	getString(nome,50);
	printf("Enlace a sua paxina web\n\t> ");
	getString(enlace,256);
   	
   	EXEC SQL INSERT INTO autor(idAutor,nome,enlace,tipo)
   	VALUES (:id, :nome, :enlace, :tipo);
   
	if(erro==0){
		if(doCommit==1)
			EXEC SQL COMMIT;
		
		printf("\n\nAutor insertado con exito\n\n\n");
	}
	pausa = getInt();
}


void engadirCritica(){
	int erro = 0;		
	EXEC SQL WHENEVER SQLERROR DO erro=errorManagerDML();
   	
	EXEC SQL BEGIN DECLARE SECTION;
		int autor;
		char titulo[50];
		char data[128];
		time_t tempo;
		struct tm *tlocal;
		int puntuacion;
		char descricion[500];
		int xogo;
		char idAutor[25];
		int pausa;
   	EXEC SQL END DECLARE SECTION;
	EXEC SQL SET TRANSACTION ISOLATION LEVEL READ COMMITED;

	printf("CRITICAS\n\n");
	printf("Autor xa rexistrado ou novo autor?:\n");
   	printf("(1)\tNovo\n");
	printf("(2)\tExistente\n");
	printf("\n\t> ");
	autor = getInt();

	if (autor == 1){

		engadirAutor(0);
		printf("CRITICAS\n\n");
	}	
	printf("Identificador do autor\n\t> ");
	getString(idAutor,25);
	printf("(*) Codigo do xogo\n\t> ");
	xogo = getInt();
	printf("(*) Titulo da critica\n\t> ");
	getString(titulo,50);
	printf("(*) Puntuacion sobre 100:\n\t>");
	puntuacion = getInt();
	printf("Descricion (un unico paragrafo)\n\t> ");
	getString(descricion,500);
	tempo = time(0);
	tlocal = localtime(&tempo);
	strftime(data,128,"%d/%m/%y",tlocal);	
   	
   	EXEC SQL INSERT INTO critica(tituloCritic,data,puntuacion,descricion,xogo,autor)
   	VALUES (:titulo, :data, :puntuacion, :descricion, :xogo, :idAutor);
   
	if(erro==0){
		EXEC SQL COMMIT;
		printf("\n\nCritica insertada con exito\n\n\n");
	}
	pausa = getInt();
}


void engadirXogo(){
	int erro = 0;		
	EXEC SQL WHENEVER SQLERROR DO erro=errorManagerDML();
   	
	EXEC SQL BEGIN DECLARE SECTION;
		char tituloXogo[50];
		char dia[4];
		char mes[4];
		char ano[6];
		char dataDeSaida[11];
		int votosPositivos,votosNegativos,pausa;
   	EXEC SQL END DECLARE SECTION;
	EXEC SQL SET TRANSACTION ISOLATION LEVEL READ COMMITED;
	
	printf("REXISTRO DE XOGOS\n\n");
	printf("(*) Titulo\n\t> ");
	getString(tituloXogo,50);
	printf("Data de saida:\n\t>Dia(dd): ");
	getString(dia,4);
	printf("\n\t>Mes(mm): ");
	getString(mes,4);
	printf("\n\t>Ano(yyyy): ");
	getString(ano,6);
	strcpy(dataDeSaida,dia);
	strcat(dataDeSaida,"/");
	strcat(dataDeSaida,mes);
	strcat(dataDeSaida,"/");
	strcat(dataDeSaida,ano);
   	votosPositivos = 0; 
	votosNegativos = 0;

   	EXEC SQL INSERT INTO xogo(tituloXogo,dataDeSaida,votosPositivos,votosNegativos)
   	VALUES (:tituloXogo, :dataDeSaida, :votosPositivos, :votosNegativos);
   
	if(erro==0){
		EXEC SQL COMMIT;
		printf("\n\nXogo insertado con exito\n\n\n");
	}
	pausa = getInt();
}



void eliminarAutor()
{
	int erro = 0;		
	EXEC SQL WHENEVER SQLERROR DO erro=errorManagerDML();

   	EXEC SQL BEGIN DECLARE SECTION;
      		char id[25];
		int pausa;
	EXEC SQL END DECLARE SECTION;
	EXEC SQL SET TRANSACTION ISOLATION LEVEL READ COMMITED;
	
	printf("ELIMINACION DE AUTORES\n\n");
	printf("Identificador do autor\n\t> "); 
	getString(id,25);

	EXEC SQL DELETE FROM autor 
		WHERE idAutor = :id;

	if (sqlca.sqlerrd[2] > 0)
		printf("\nAutor eliminado con exito\n\n\n");
	else
		printf("\nAutor non eliminado\n\n\n");

	if (!erro) 
		EXEC SQL COMMIT;

	pausa = getInt();
}


void eliminarXogo()
{
	int erro = 0;		
	EXEC SQL WHENEVER SQLERROR DO erro=errorManagerDML();

   	EXEC SQL BEGIN DECLARE SECTION;
      		int cod,pausa;
	EXEC SQL END DECLARE SECTION;
	EXEC SQL SET TRANSACTION ISOLATION LEVEL READ COMMITED;

	printf("ELIMINACION DE XOGOS\n\n");
	printf("Codigo do xogo\n\t> "); 
	cod = getInt();

	EXEC SQL DELETE FROM xogo 
		WHERE codXogo = :cod;

	if (sqlca.sqlerrd[2] > 0)
		printf("\nXogo eliminado con exito\n\n\n");
	else
		printf("\nNon se encontrou o codigo, polo tanto o xogo non foi eliminado\n\n\n");

	if (!erro) 
		EXEC SQL COMMIT;

	pausa = getInt();	
}




void buscarCritica() {
	int erro = 0;		
	EXEC SQL WHENEVER SQLERROR DO erro=errorManagerDML();
	
	printf("Funcion buscarCritica().\n");
   	EXEC SQL BEGIN DECLARE SECTION;
        int codCritic;
        char tituloCritic[51];
        char autor[51];
        int puntuacion;
        char dataC[11];
        short dataC_ind;
        char descripcion[501];
        char xogo[51];
	EXEC SQL END DECLARE SECTION;

        printf("Introduzca o codigo da critica[0 para sair]: ");
   	codCritic = getInt();

        EXEC SQL SET TRANSACTION READ ONLY;

	//Control de salida
        
	if(codCritic == 0){
		EXEC SQL COMMIT;
                return;
        }

        EXEC SQL SELECT codCritic, tituloCritic, (SELECT tituloXogo FROM xogo WHERE codXogo=c.xogo), (SELECT nome FROM autor WHERE idAutor=c.autor), puntuacion,descricion, TO_CHAR(data, 'dd/mm/yyyy')
                INTO :codCritic,:tituloCritic,:xogo,:autor,:puntuacion,:descripcion,:dataC:dataC_ind
        FROM critica c
        WHERE codCritic=:codCritic ;

	if(sqlca.sqlcode == 1403){
		printf("Non hai criticas con ese codigo.");
	}else{
		printf("--Critica--\n--Codigo--\t--Titulo--\t--Autor--\t--Puntuacion--\n");
		printf(" %d\t%s\t%s\t%s\t%d\n",codCritic,tituloCritic,xogo,autor,puntuacion);
		printf("-----------------------------------------------------------------\n");
		printf("%s\n",descripcion);
		if(dataC_ind==0)printf("Datado de: %s\n",dataC);
	}
	if(!erro) EXEC SQL COMMIT;
}

void listarCriticasXogo( int id)
{
        int erro = 0;		
	EXEC SQL WHENEVER SQLERROR DO erro=errorManagerDML();
	
	printf("Funcion listarCriticasXogo().\n");
   	EXEC SQL BEGIN DECLARE SECTION;
      	int identificador;
        int codCritic;
        char tituloCritic[51];
        char autor[51];
        int puntuacion;
	EXEC SQL END DECLARE SECTION;

        identificador=id;

	EXEC SQL SET TRANSACTION READ ONLY;	
	
                EXEC SQL DECLARE cursor_critics CURSOR FOR
                SELECT codCritic, tituloCritic, (SELECT nome FROM autor WHERE idAutor=c.autor), puntuacion 
                FROM critica c 
		WHERE xogo=:identificador;

	EXEC SQL OPEN cursor_critics;	
	EXEC SQL WHENEVER NOT FOUND DO BREAK;
	printf("--Criticas--\n--Codigo--\t--Titulo--\t--Autor--\t--Puntuacion--\n");
	while(1) {
		EXEC SQL FETCH cursor_critics
		INTO :codCritic,:tituloCritic,:autor,:puntuacion;
		if(sqlca.sqlcode == 1403){
			printf("Non hai criticas para este xogo.\n");
		}else{
			printf(" %d\t%s\t%s\t%d\n",codCritic,tituloCritic,autor,puntuacion);
		}
	}
        
        EXEC SQL WHENEVER NOT FOUND CONTINUE;
	printf("Criticas atopados: %d.\n", sqlca.sqlerrd[2]);
	EXEC SQL CLOSE cursor_critics;
        
        if(!erro) EXEC SQL COMMIT;
        
        buscarCritica();
}

void listarCriticasAutor(char *id, int len)
{
        int erro = 0;		
	EXEC SQL WHENEVER SQLERROR DO erro=errorManagerDML();
	
	printf("Funcion listarCriticasAutor().\n");
   	EXEC SQL BEGIN DECLARE SECTION;
      	VARCHAR patron[25];
        int codCritic;
        char tituloCritic[51];
        char xogo[51];
        int puntuacion;
	EXEC SQL END DECLARE SECTION;


	strncpy(patron.arr, id, len);
	patron.len=len;

	EXEC SQL SET TRANSACTION READ ONLY;	
	
		EXEC SQL DECLARE cursor_criticsA CURSOR FOR
                SELECT codCritic, tituloCritic, (SELECT tituloXogo FROM xogo WHERE codXogo=c.xogo), puntuacion 
                FROM critica c 
				WHERE autor = :patron;

	EXEC SQL OPEN cursor_criticsA;	
	EXEC SQL WHENEVER NOT FOUND DO BREAK;
	printf("--Criticas--\n--Codigo--\t--Titulo--\t--Xogo--\t--Puntuacion--\n");
	while(1) {
		EXEC SQL FETCH cursor_criticsA
		INTO :codCritic,:tituloCritic,:xogo,:puntuacion;
		if(sqlca.sqlcode == 1403){
			printf("Non hai criticas para este autor.\n");
		}else{
			printf(" %d\t%s\t%s\t%d\n",codCritic,tituloCritic,xogo,puntuacion);
		}
	}
        
    EXEC SQL WHENEVER NOT FOUND CONTINUE;
	printf("Criticas atopados: %d.\n", sqlca.sqlerrd[2]);
	EXEC SQL CLOSE cursor_criticsA;
        
        if(!erro) EXEC SQL COMMIT;
        
        buscarCritica();
}

void buscarXogoCodigo()
{
	int erro = 0;		
	EXEC SQL WHENEVER SQLERROR DO erro=errorManagerDML();
	
	printf("Funcion buscarXogoCodigo().\n");
   	EXEC SQL BEGIN DECLARE SECTION;
      	int codXogo;
	char tituloXogo[51];
	char dataDeSaida[11];
	short dataDeSaida_ind;
        int votosPositivos;
        int votosNegativos;
        int notaMedia;
	EXEC SQL END DECLARE SECTION;

	EXEC SQL SET TRANSACTION READ ONLY;	

	printf("Introduzca o codigo do xogo[0 para sair]: ");
   	codXogo=getInt();

	//Control de salida
	if (codXogo==0){
		EXEC SQL COMMIT;
                return;
        }
	EXEC SQL SELECT codXogo,tituloXogo,TO_CHAR(dataDeSaida, 'dd/mm/yyyy')   ,votosPositivos,votosNegativos, nvl((SELECT AVG(puntuacion) FROM critica WHERE xogo=x.codXogo),0) 
		INTO :codXogo,:tituloXogo,:dataDeSaida:dataDeSaida_ind,:votosPositivos,:votosNegativos,:notaMedia
                FROM xogo x
		WHERE codXogo=:codXogo;

	

	if(sqlca.sqlcode == 1403)	
		printf("No se encontro el codigo indicado.\n");
	else  {
                printf("--Xogo--\n--Codigo--\t--Titulo--\t--Data de saida--\t--Votos Positivos--\t--Votos Negativos--\t--Nota Media--\n");
                if(dataDeSaida_ind == 0)
                        printf(" %d\t%s\t%s\t%d\t%d\t%d\n",codXogo,tituloXogo,dataDeSaida,votosPositivos,votosNegativos,notaMedia);
                else
                        printf(" %d\t%s\tSen data\t%d\t%d\t%d\n",codXogo,tituloXogo,votosPositivos,votosNegativos,notaMedia);	
        }
        if(!erro) EXEC SQL COMMIT;
        
        listarCriticasXogo(codXogo);

}

void buscarXogoTitulo()
{
	int erro = 0;		
	EXEC SQL WHENEVER SQLERROR DO erro=errorManagerDML();
	
	printf("Funcion buscarXogoTitulo().\n");
   	EXEC SQL BEGIN DECLARE SECTION;
      	int codXogo;
        char tituloXogo[51], patron[53];
        char dataDeSaida[11];
        short dataDeSaida_ind;
        int votosPositivos;
        int votosNegativos;
        int notaMedia;
	EXEC SQL END DECLARE SECTION;

	EXEC SQL SET TRANSACTION READ ONLY;	

	printf("Introduzca o titulo do xogo: ");
   	getString(tituloXogo,50);

    strcpy(patron, "%");
	strcat(patron, tituloXogo);
	strcat(patron, "%");

	EXEC SQL DECLARE cursor_xogoT CURSOR FOR 
	SELECT codXogo,tituloXogo,TO_CHAR(dataDeSaida, 'dd/mm/yyyy'),votosPositivos,votosNegativos,nvl((SELECT AVG(puntuacion) FROM critica WHERE xogo=x.codXogo),0) 
		
                FROM xogo x 
		WHERE tituloXogo LIKE :patron;

	EXEC SQL OPEN cursor_xogoT;	
	EXEC SQL WHENEVER NOT FOUND DO BREAK;
                printf("--Xogos--\n--Codigo--\t--Titulo--\t--Data de saida--\t--Votos Positivos--\t--Votos Negativos--\t--Nota Media--\n");
	while(1){
		EXEC SQL FETCH cursor_xogoT
		INTO :codXogo,:tituloXogo,:dataDeSaida:dataDeSaida_ind,:votosPositivos,:votosNegativos,:notaMedia;
	if(sqlca.sqlcode == 1403)	
		printf("No se encontro el titulo indicado.\n");
	else {
                if(dataDeSaida_ind == 0)
                        printf(" %d\t%s\t%s\t%d\t%d\t%d\n",codXogo,tituloXogo,dataDeSaida,votosPositivos,votosNegativos,notaMedia);
                else
                        printf(" %d\t%s\tSen data\t%d\t%d\t%d\n",codXogo,tituloXogo,votosPositivos,votosNegativos,notaMedia);	
        }
        }
        EXEC SQL WHENEVER NOT FOUND CONTINUE;
       EXEC SQL CLOSE cursor_xogoT;
        if(!erro) EXEC SQL COMMIT;
        
        listarCriticasXogo(codXogo);

}

void buscarAutor()
{
	int erro = 0;		
	EXEC SQL WHENEVER SQLERROR DO erro=errorManagerDML();
	
	printf("Funcion buscarAutor().\n");
   	EXEC SQL BEGIN DECLARE SECTION;
      	VARCHAR idAutor[25];
        char nome[51], patron[53];
	char enlace[257];
	short enlace_ind;
        char tipo[31];
	EXEC SQL END DECLARE SECTION;

	EXEC SQL SET TRANSACTION READ ONLY;	

	printf("Introduzca o nome do autor: ");
   	getString(nome,50);

 	strcpy(patron, "%");
	strcat(patron, nome);
	strcat(patron, "%");

	EXEC SQL DECLARE cursor_autor CURSOR FOR
		SELECT idAutor, nome, enlace, tipo
                FROM autor 
		WHERE nome LIKE :patron;

	EXEC SQL OPEN cursor_autor;	
	EXEC SQL WHENEVER NOT FOUND DO BREAK;

	              printf("--Autores--\n--Codigo--\t--Nome--\t--Enlace--\t--Tipo--\n");
	while(1){
		EXEC SQL FETCH cursor_autor
		INTO :idAutor,:nome,:enlace:enlace_ind,:tipo;
	if(sqlca.sqlcode == 1403)	
		printf("No se encontro el autor indicado.\n");
	else {
                if(enlace_ind == 0)
                        printf(" %.*s\t%s\t%s\t%s\n",idAutor.len,idAutor.arr,nome,enlace,tipo);
                else
                        printf(" %.*s\t%s\tSen enlace\t%s\n",idAutor.len,idAutor.arr,nome,tipo);
					}	
    }
     EXEC SQL WHENEVER NOT FOUND CONTINUE;
       EXEC SQL CLOSE cursor_autor;
        if(!erro) EXEC SQL COMMIT;
        
        listarCriticasAutor(idAutor.arr, idAutor.len);
}


void listarXogos()
{
	int erro = 0;		
	EXEC SQL WHENEVER SQLERROR DO erro=errorManagerDML();
	
	printf("Funcion listarXogos().\n");
   	EXEC SQL BEGIN DECLARE SECTION;
      	int codXogo;
	char tituloXogo[51];
	char dataDeSaida[11];
	short dataDeSaida_ind;
        int votosPositivos;
        int votosNegativos;
        int notaMedia;
	EXEC SQL END DECLARE SECTION;

	EXEC SQL SET TRANSACTION READ ONLY;	

	EXEC SQL DECLARE cursor_elementos CURSOR FOR
		SELECT codXogo,tituloXogo, TO_CHAR(dataDeSaida, 'dd/mm/yyyy'),votosPositivos,votosNegativos,nvl((SELECT AVG(puntuacion) FROM critica WHERE xogo=x.codXogo),0) 
		FROM xogo x;
	
	EXEC SQL OPEN cursor_elementos;	
	EXEC SQL WHENEVER NOT FOUND DO BREAK;
	
	printf("--Xogos--\n--Codigo--\t--Titulo--\t--Data de saida--\t--Votos Positivos--\t--Votos Negativos--\t--Nota Media--\n");
	
	while(1) {
		EXEC SQL FETCH cursor_elementos
		INTO :codXogo,:tituloXogo,:dataDeSaida:dataDeSaida_ind,:votosPositivos,:votosNegativos,:notaMedia;
		if(sqlca.sqlcode == 1403)	
			printf("Non hai xogos.\n");
		else{
            
			if(dataDeSaida_ind == 0)
				printf(" %d\t%s\t%s\t%d\t%d\t%d\n",codXogo,tituloXogo,dataDeSaida,votosPositivos,votosNegativos,notaMedia);
			else
				printf(" %d\t%s\tSen data\t%d\t%d\t%d\n",codXogo,tituloXogo,votosPositivos,votosNegativos,notaMedia);
			 }
	}
         
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	printf("Xogos atopados: %d.\n", sqlca.sqlerrd[2]);
	EXEC SQL CLOSE cursor_elementos;

	if(!erro) EXEC SQL COMMIT;
	
	buscarXogoCodigo();
}


void mostrarVotos(int codXogo){
	int erro = 0;
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	
	EXEC SQL BEGIN DECLARE SECTION;
		int cod,votosP,votosN;
		char titulo[50];
	EXEC SQL END DECLARE SECTION; 

	EXEC SQL SET TRANSACTION READ ONLY;

	cod = codXogo;

	EXEC SQL SELECT tituloXogo, votosPositivos, votosNegativos  
	INTO :titulo,:votosP, :votosN
	FROM xogo
	WHERE codXogo = :cod;
	
	printf("\n%s",titulo);
	printf("\n\tVotos positivos: %d",votosP);
	printf("\n\tVotos negativos: %d",votosN);
	
	if (!erro)
		EXEC SQL COMMIT;
		
}


void editarAutor()
{
	int erro = 0;		
	EXEC SQL WHENEVER SQLERROR DO erro=errorManagerDML();
	
   	EXEC SQL BEGIN DECLARE SECTION;
      		char idAutor[25];
		char nome[50];
		char enlace[256];
		int pausa;
	EXEC SQL END DECLARE SECTION;
	
	EXEC SQL SET TRANSACTION ISOLATION LEVEL SERIALIZABLE;

	printf("EDITAR DATOS DE AUTOR\n\n");
	printf("Identificador do autor a modificar> "); 
	getString(idAutor,25);
	printf("\nInserte os novos datos:\n\n");
	printf("(*) Nome\n\t> ");
	getString(nome,50);
	printf("Enlace a sua paxina web\n\t> ");
	getString(enlace,256);

	EXEC SQL UPDATE autor
		SET nome = :nome, enlace =:enlace
		WHERE idAutor = :idAutor;

	if(!erro){
		EXEC SQL COMMIT;
		printf("\n\nDatos editados con exito!\n\n\n");	
	}
	pausa = getInt();
}

void votarPositivamente()
{
	int erro = 0;		
	EXEC SQL WHENEVER SQLERROR DO erro=errorManagerDML();
	
   	EXEC SQL BEGIN DECLARE SECTION;
      		int codXogo,pausa;
	EXEC SQL END DECLARE SECTION;
	
	EXEC SQL SET TRANSACTION ISOLATION LEVEL SERIALIZABLE;

	printf("VOTAR POSITIVAMENTE\n\n");
	printf("Codigo do xogo> "); 
	codXogo = getInt();

	EXEC SQL UPDATE xogo
		SET votosPositivos = votosPositivos + 1
		WHERE codXogo = :codXogo;

	if(!erro){
		EXEC SQL COMMIT;
		mostrarVotos(codXogo);
		printf("\n\nGracias por votar!\n\n\n");	
	}
	pausa = getInt();
}


void votarNegativamente()
{
	int erro = 0;		
	EXEC SQL WHENEVER SQLERROR DO erro=errorManagerDML();
	
   	EXEC SQL BEGIN DECLARE SECTION;
      		int codXogo,pausa;
	EXEC SQL END DECLARE SECTION;
	
	EXEC SQL SET TRANSACTION ISOLATION LEVEL SERIALIZABLE;

	printf("VOTAR NEGATIVAMENTE\n\n");
	printf("Codigo do xogo> "); 
	codXogo = getInt();

	EXEC SQL UPDATE xogo
		SET votosNegativos = votosNegativos + 1
		WHERE codXogo = :codXogo;

	if(!erro){
		EXEC SQL COMMIT;
		mostrarVotos(codXogo);
		printf("\n\nGracias por votar!\n\n\n");	
	}

	pausa = getInt();
}


/* Funcion principal */
int main()
{
  conectaBD();

  int op;

  while ( (op=menu()) != 0){
       switch(op){
            case 1: listarXogos(); break;
            case 2: buscarXogoTitulo(); break;
            case 3: buscarAutor(); break;
	    case 4: engadirCritica(); break;
	    case 5: engadirAutor(1); break;
	    case 6: engadirXogo(); break;
	    case 7: eliminarXogo(); break;
	    case 8: eliminarAutor(); break;
	    case 9: editarAutor(); break;
	    case 10: votarPositivamente(); break;
	    case 11: votarNegativamente(); break;
       }

  }
 


 desconectaBD(); 

 return 0;
}



